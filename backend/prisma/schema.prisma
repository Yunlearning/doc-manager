generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── Auth Models ──────────────────────────────────────

enum Role {
  ADMIN
  USER
}

enum Permission {
  UPLOAD
  DOWNLOAD
  CREATE_PROJECT
  DELETE_DOCUMENT
}

model User {
  id             String    @id @default(uuid()) @db.Uuid
  email          String    @unique @db.VarChar(255)
  password       String    @db.VarChar(255)
  name           String    @db.VarChar(100)
  role           Role      @default(USER)
  isActive       Boolean   @default(true) @map("is_active")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lockedUntil    DateTime? @map("locked_until")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  permissions UserPermission[]
  loginLogs   LoginLog[]

  @@map("users")
}

model UserPermission {
  id         String     @id @default(uuid()) @db.Uuid
  userId     String     @map("user_id") @db.Uuid
  permission Permission

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@map("user_permissions")
}

model LoginLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  ipAddress String   @map("ip_address") @db.VarChar(45)
  userAgent String   @map("user_agent") @db.Text
  location  String?  @db.VarChar(255)
  loginAt   DateTime @default(now()) @map("login_at")
  success   Boolean

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginAt])
  @@map("login_logs")
}

// ── Business Models ──────────────────────────────────

model Project {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  standardType String   @map("standard_type") @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tiers DocumentTier[]

  @@map("projects")
}

model DocumentTier {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  name      String   @db.VarChar(255)
  tierLevel Int      @map("tier_level") @db.SmallInt
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent    DocumentTier?  @relation("TierHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  DocumentTier[] @relation("TierHierarchy")
  documents Document[]

  @@index([projectId])
  @@index([parentId])
  @@map("document_tiers")
}

model Document {
  id         String   @id @default(uuid()) @db.Uuid
  tierId     String   @map("tier_id") @db.Uuid
  title      String   @db.VarChar(500)
  fileName   String   @map("file_name") @db.VarChar(500)
  filePath   String   @map("file_path") @db.VarChar(1000)
  mimeType   String   @map("mime_type") @db.VarChar(255)
  fileSize   BigInt   @map("file_size")
  version    String   @default("v1.0") @db.VarChar(20)
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tier DocumentTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  @@index([tierId])
  @@map("documents")
}
